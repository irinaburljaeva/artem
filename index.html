<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Language Lab Escape ‚Äî Advanced (B2)</title>
<style>
  :root{
    --bg:#0d0d10; --panel:rgba(10,10,12,.86); --ink:#f3e9d2;
    --acc:#d4a373; --acc2:#e7b67a; --err:#ff6b6b; --ok:#7df9b7;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Georgia,serif;overflow:hidden}
  #stage{
    position:relative;width:100vw;height:100vh;background:#000 center/cover no-repeat;
    display:flex;flex-direction:column;justify-content:flex-end;padding:40px;box-sizing:border-box
  }
  .panel{background:var(--panel);border:1px solid #2c2c39;border-radius:14px;max-width:880px;padding:22px 24px;box-shadow:0 0 18px rgba(0,0,0,.55)}
  h1,h2{margin:.2em 0;text-align:center;color:#ff7a00;font-weight:700}
  p{margin:.6em 0}
  .row{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input,select{
    background:#15151c;border:1px solid #2c2c39;color:#fff;border-radius:8px;
    padding:10px 12px;min-width:180px
  }
  button{
    background:var(--acc);border:0;color:#1a1a1a;padding:10px 18px;border-radius:10px;cursor:pointer;
    font-weight:600
  }
  button:hover{background:var(--acc2)}
  .ghost{opacity:.7;font-style:italic;color:#b9b6cc}
  .msg{margin-top:8px;min-height:22px}
  .ok{color:var(--ok);font-weight:700}
  .bad{color:var(--err);font-weight:700}
  .controls{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
  .grid{display:grid;grid-template-columns:minmax(0,1fr);gap:14px}
  .fade{animation:fade .9s}
  @keyframes fade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
  .muted{opacity:.6}
  .small{font-size:.95em}
  .tag{padding:2px 8px;border:1px dashed #444;border-radius:999px;font-size:.85em;color:#ccc}
  .center{text-align:center}
  .space{height:10px}
</style>
</head>
<body>
<div id="stage">
  <div id="panel" class="panel fade">
    <h1>Language Lab Escape ‚Äî Advanced</h1>
    <p class="center small ghost">Solve each language puzzle to move to the next room. Hints are limited.</p>
    <div class="space"></div>

    <!-- INTRO -->
    <div id="scene-intro" class="grid">
      <p>You stayed late in the language lab to finish your homework. When you finally stand up, the automatic door is locked. The screen on the wall lights up:</p>
      <p class="ghost center"><em>‚ÄúComplete every English task and the door will open.‚Äù</em></p>
      <p id="sessionInfo" class="center small muted"></p>
      <div class="controls center">
        <button id="startBtn">Enter the Vocabulary Library</button>
        <span id="hintCounter" class="tag">Hints left: <b>3</b></span>
      </div>
    </div>

    <!-- ROOM 1 ‚Äî LIBRARY -->
    <div id="scene-lib" class="grid" style="display:none">
      <h2>Room 1 ‚Äî Vocabulary Library</h2>

      <!-- Step A -->
      <div id="libA">
        <p>On one shelf you see four course folders:</p>
        <ul>
          <li><b>R</b>eading Strategies</li>
          <li><b>E</b>xtensive Listening</li>
          <li><b>A</b>cademic Writing</li>
          <li><b>D</b>aily Conversation</li>
        </ul>
        <p class="ghost">A note on the screen says: <em>‚ÄúTheir initials tell you what you should do with books.‚Äù</em></p>
        <div class="row">
          <input id="libWord" placeholder="secret word (one word)">
          <button onclick="checkLibA()">Confirm</button>
          <button onclick="hint('libA')">Hint</button>
        </div>
        <div id="libMsgA" class="msg"></div>
      </div>

      <!-- Step B -->
      <div id="libB" style="display:none">
        <p>New words appear across the whiteboard:</p>
        <blockquote>
          <b>grammar</b><br/>
          <b>pronunciation</b><br/>
          <b>vocabulary</b><br/>
          <b>fluency</b>
        </blockquote>
        <p class="ghost">Follow the rule to get a four-digit code:</p>
        <ul class="small">
          <li>Take the number of letters in <b>grammar</b> and keep it as it is.</li>
          <li>Take the number of letters in <b>pronunciation</b> and use only the last digit.</li>
          <li>Do the same with <b>vocabulary</b> and <b>fluency</b>.</li>
        </ul>
        <div class="row">
          <input id="libCode" placeholder="4-digit code">
          <button onclick="checkLibB()">Unlock</button>
          <button onclick="hint('libB')">Hint</button>
        </div>
        <div id="libMsgB" class="msg"></div>
      </div>
    </div>

    <!-- ROOM 2 ‚Äî GRAMMAR LAB -->
    <div id="scene-alc" class="grid" style="display:none">
      <h2>Room 2 ‚Äî Grammar Lab</h2>

      <!-- Step A -->
      <div id="alcA">
        <p>On the desk you see three example sentences on sticky notes:</p>
        <blockquote class="ghost">
          1. <b>I have already finished the report.</b><br/>
          2. <b>She was cooking when he came home.</b><br/>
          3. <b>By next July, they will have moved abroad.</b>
        </blockquote>
        <p>Write the <b>names of the three tenses</b> in the correct order, comma-separated.</p>
        <p class="small muted">Use lowercase, English names, no spaces around commas. Example: <code>present perfect,past simple,future simple</code>.</p>
        <div class="row">
          <input id="alcWords" placeholder="e.g. present perfect,past...,future...">
          <button onclick="checkAlcA()">Check</button>
          <button onclick="hint('alcA')">Hint</button>
        </div>
        <div id="alcMsgA" class="msg"></div>
      </div>

      <!-- Step B -->
      <div id="alcB" style="display:none">
        <p>A circle on the screen says:</p>
        <p class="ghost small"><em>‚ÄúNow take the value of the Roman numerals hidden in the three tense names you just wrote.‚Äù</em></p>
        <p class="small muted">Consider only the letters that are Roman numerals (<code>I, V, X, L, C, D, M</code>) inside the words
          <code>present perfect</code>, <code>past continuous</code>, and <code>future perfect</code>. Add their values together.</p>
        <div class="row">
          <input id="alcCode" placeholder="number (3 digits)">
          <button onclick="checkAlcB()">Confirm</button>
          <button onclick="hint('alcB')">Hint</button>
        </div>
        <div id="alcMsgB" class="msg"></div>
      </div>
    </div>

    <!-- ROOM 3 ‚Äî HALL OF MIRRORS -->
    <div id="scene-mir" class="grid" style="display:none">
      <h2>Room 3 ‚Äî The Hall of Mirrors</h2>

      <!-- Step A -->
      <div id="mirA">
        <p>On a glass panel a backward word appears: <code class="muted">NOITCELFER</code>.</p>
        <p class="ghost">Write it as you would in a normal, non-mirrored world.</p>
        <div class="row">
          <input id="mirWord" placeholder="word">
          <button onclick="checkMirA()">Reveal</button>
          <button onclick="hint('mirA')">Hint</button>
        </div>
        <div id="mirMsgA" class="msg"></div>
      </div>

      <!-- Step B -->
      <div id="mirB" style="display:none">
        <p>Letters arrange into a pattern, but every second letter is missing:</p>
        <blockquote class="ghost"><code>C N D E I H T</code></blockquote>
        <p>Under the frame you notice another repeating pattern: <code>A L G H T</code>.</p>
        <p class="small muted">Interleave the two streams of letters to form one meaningful English word.</p>
        <div class="row">
          <input id="mirFinal" placeholder="final word">
          <button onclick="checkMirB()">Assemble</button>
          <button onclick="hint('mirB')">Hint</button>
        </div>
        <div id="mirMsgB" class="msg"></div>
      </div>
    </div>

    <!-- ROOM 4 ‚Äî THE FINAL DOOR -->
    <div id="scene-door" class="grid" style="display:none">
      <h2>The Final Door</h2>

      <!-- Step A -->
      <div id="doorA">
        <p>On the arch a short poem about the year is projected. The first letters glow:</p>
        <blockquote class="ghost">
          <b>A</b>fter heat, the air grows thin;<br/>
          <b>U</b>nder trees, the fires dim;<br/>
          <b>T</b>ired light turns copper, then;<br/>
          <b>U</b>ntied winds bring leaves to spin;<br/>
          <b>M</b>oss and smoke, a scented hymn;<br/>
          <b>N</b>ight comes early. Name the season.
        </blockquote>
        <div class="row">
          <input id="doorSeason" placeholder="season (one word)">
          <button onclick="checkDoorA()">Confirm</button>
          <button onclick="hint('doorA')">Hint</button>
        </div>
        <div id="doorMsgA" class="msg"></div>
      </div>

      <!-- Step B -->
      <div id="doorB" style="display:none">
        <p>Three locks remain. Enter the knowledge you gathered:</p>
        <ul class="small">
          <li>Library code (4 digits)</li>
          <li>Mirrors word (all caps)</li>
          <li>The season (from the poem)</li>
        </ul>
        <div class="row">
          <input id="lockLib" placeholder="code">
          <input id="lockMir" placeholder="word">
          <input id="lockSeason" placeholder="season">
          <button onclick="checkDoorB()">Open</button>
        </div>
        <div id="doorMsgB" class="msg"></div>
      </div>
    </div>

    <!-- END -->
    <div id="scene-end" class="grid center" style="display:none">
      <h2>You Escaped the Language Lab! üéâ</h2>
      <p>The lock clicks. The classroom lights turn on again, and the door finally slides open.</p>
    </div>

  </div>
</div>

<script type="module">
/* ---------- FIREBASE (WRITE-ONLY SESSION TRACKING) ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* TODO: –í–°–¢–ê–í–¨ –°–í–û–ô –ö–û–ù–§–ò–ì */
const firebaseConfig = {
  apiKey: "AIzaSyCe3jIpFH630mfdkdxdTjCmquEGdPMvFHA",
  authDomain: "polytalky-2228d.firebaseapp.com",
  projectId: "polytalky-2228d",
  storageBucket: "polytalky-2228d.firebasestorage.app",
  messagingSenderId: "498740130503",
  appId: "1:498740130503:web:5e2061ec4011ec983144e2",
  measurementId: "G-3HCWZX1R92"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

let sessionId = null;
let answers   = {};

/* –≥–µ–Ω–µ—Ä–∞—Ü–∏—è / —á—Ç–µ–Ω–∏–µ –∫–æ–¥–∞ —Å–µ—Å—Å–∏–∏ */
function generateSessionId(){
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let s = '';
  for (let i = 0; i < 5; i++) {
    s += chars[Math.floor(Math.random() * chars.length)];
  }
  return s;
}

async function updateSession(patch = {}) {
  if (!db || !sessionId) return;
  try {
    const ref = doc(db, "escapeSessions", sessionId);
    await setDoc(ref, {
      sessionId,
      ...patch,
      updatedAt: Date.now()
    }, { merge: true });
  } catch (e) {
    console.error('updateSession error', e);
  }
}

function initSession() {
  const params = new URLSearchParams(window.location.search);
  sessionId = params.get('session') || generateSessionId();

  const infoEl = document.getElementById('sessionInfo');
  if (infoEl) {
    infoEl.textContent = `Session code: ${sessionId}`;
  }

  updateSession({
    currentScene: 'intro',
    currentStep : 'intro',
    answers
  });
}

/* ---------- ASSETS / BACKGROUNDS ---------- */
const bg = {
  intro: 'intro.png',
  lib: 'library.png',
  alc: 'alchemy.png',
  mir: 'mirrors.png',
  door: 'door.png'
};
const stage     = document.getElementById('stage');
const hintBadge = document.getElementById('hintCounter');
let hintsLeft   = 3;
let attempts    = {libA:0, libB:0, alcA:0, alcB:0, mirA:0, mirB:0, doorA:0, doorB:0};

/* ---------- VIEW HELPERS ---------- */
function showScene(id, bgKey){
  document.querySelectorAll('[id^="scene-"]').forEach(s=>s.style.display='none');
  document.getElementById(id).style.display='grid';
  stage.style.backgroundImage = `url(${bg[bgKey]})`;
}
function showStep(stepId){
  const el = document.getElementById(stepId);
  el.style.display='block';
  el.classList.add('fade');
}
function hide(el){ el.style.display='none'; }
function setMsg(id, html){ document.getElementById(id).innerHTML = html; }
function useHint(){
  if (hintsLeft<=0) return false;
  hintsLeft--;
  hintBadge.innerHTML = `Hints left: <b>${hintsLeft}</b>`;
  updateSession({ hintsLeft });
  return true;
}

/* ---------- HINTS ---------- */
function hint(where){
  if(!useHint()) return;
  const map = {
    libA: 'Look at the FIRST letters of the four folders: Reading, Extensive, Academic, Daily.',
    libB: 'Count letters: grammar (7), pronunciation (13 ‚Üí last digit 3), vocabulary (10 ‚Üí 0), fluency (7). This gives 7-3-0-7 ‚Üí 7307.',
    alcA: '1) present perfect, 2) past continuous, 3) future perfect. Write them exactly like this: present perfect,past continuous,future perfect.',
    alcB: 'In the three tense names only the letters C (100) and I (1) are Roman numerals. Together they make 301.',
    mirA: 'Read the backward word normally: NOITCELFER ‚Üí REFLECTION.',
    mirB: 'Interleave the two streams: C N D E I H T with A L G H T ‚Üí C A N D L E L I G H T.',
    doorA:'Read the acrostic: the first letters spell AUTUMN.',
    doorB:'You need the library code (7307), the mirrors word (CANDLELIGHT), and the season (autumn).'
  };
  alert(map[where]);
}

/* ---------- FLOW ---------- */
document.getElementById('startBtn').addEventListener('click', ()=>{
  showScene('scene-lib','lib');  // to library
  updateSession({
    currentScene: 'lib',
    currentStep : 'libA',
    answers
  });
});

/* ---------- ROOM 1: LIBRARY ---------- */
function checkLibA(){
  attempts.libA++;
  const v = document.getElementById('libWord').value.trim();
  const upper = v.toUpperCase();
  if(upper==='READ'){
    answers.libWord = v;
    setMsg('libMsgA','<span class="ok">Exactly. The screen flashes: ‚ÄúGood readers make great learners.‚Äù</span>');
    hide(document.getElementById('libA'));
    showStep('libB');
    updateSession({
      currentScene: 'lib',
      currentStep : 'libB',
      answers,
      attempts
    });
  } else {
    setMsg('libMsgA', `<span class="bad">Not this word. Think of what you do with books: R(eading), E..., A..., D....</span>`);
    updateSession({ currentScene:'lib', currentStep:'libA', attempts });
  }
}

function checkLibB(){
  attempts.libB++;
  const v = document.getElementById('libCode').value.trim();
  if(v==='7307'){
    answers.libCode = v;
    setMsg('libMsgB','<span class="ok">Correct code. The next door in the lab slides open‚Ä¶</span>');
    updateSession({
      currentScene: 'alc',
      currentStep : 'alcA',
      answers,
      attempts
    });
    setTimeout(()=>{ showScene('scene-alc','alc'); showStep('alcA'); }, 800);
  }else{
    setMsg('libMsgB','<span class="bad">Nothing happens. Recalculate the letters of each word.</span>');
    updateSession({ currentScene:'lib', currentStep:'libB', attempts });
  }
}

/* ---------- ROOM 2: GRAMMAR LAB ---------- */
function checkAlcA(){
  attempts.alcA++;
  const v = document.getElementById('alcWords').value.trim().toLowerCase();
  if(v==='present perfect,past continuous,future perfect'){
    answers.alcTenses = v;
    setMsg('alcMsgA','<span class="ok">Nice! The system recognises the tenses and unlocks the next task.</span>');
    hide(document.getElementById('alcA')); showStep('alcB');
    updateSession({
      currentScene:'alc',
      currentStep :'alcB',
      answers,
      attempts
    });
  }else{
    setMsg('alcMsgA','<span class="bad">Check the tense names and their order. Use lowercase, no spaces around commas.</span>');
    updateSession({ currentScene:'alc', currentStep:'alcA', attempts });
  }
}

function checkAlcB(){
  attempts.alcB++;
  const v = document.getElementById('alcCode').value.trim();
  if(v==='301'){
    answers.alcCode = v;
    setMsg('alcMsgB','<span class="ok">The number is accepted. Another door in the lab opens‚Ä¶</span>');
    updateSession({
      currentScene:'mir',
      currentStep :'mirA',
      answers,
      attempts
    });
    setTimeout(()=>{ showScene('scene-mir','mir'); showStep('mirA'); }, 800);
  }else{
    setMsg('alcMsgB','<span class="bad">Not this number. Count only Roman numeral letters in the three tense names.</span>');
    updateSession({ currentScene:'alc', currentStep:'alcB', attempts });
  }
}

/* ---------- ROOM 3: MIRRORS ---------- */
function checkMirA(){
  attempts.mirA++;
  const v = document.getElementById('mirWord').value.trim();
  const upper = v.toUpperCase();
  if(upper==='REFLECTION'){
    answers.mirWord = v;
    setMsg('mirMsgA','<span class="ok">Correct. The mirrors rearrange and show another word puzzle‚Ä¶</span>');
    hide(document.getElementById('mirA')); showStep('mirB');
    updateSession({
      currentScene:'mir',
      currentStep :'mirB',
      answers,
      attempts
    });
  }else{
    setMsg('mirMsgA','<span class="bad">Try reading the backward word from right to left.</span>');
    updateSession({ currentScene:'mir', currentStep:'mirA', attempts });
  }
}

function checkMirB(){
  attempts.mirB++;
  const v = document.getElementById('mirFinal').value.trim();
  const upper = v.toUpperCase();
  if(upper==='CANDLELIGHT'){
    answers.mirFinal = v;
    setMsg('mirMsgB','<span class="ok">Well done. A passage leads you to the final door‚Ä¶</span>');
    updateSession({
      currentScene:'door',
      currentStep :'doorA',
      answers,
      attempts
    });
    setTimeout(()=>{ showScene('scene-door','door'); showStep('doorA'); }, 800);
  }else{
    setMsg('mirMsgB','<span class="bad">The word should be a single, meaningful noun. Interleave the two streams carefully.</span>');
    updateSession({ currentScene:'mir', currentStep:'mirB', attempts });
  }
}

/* ---------- ROOM 4: FINAL DOOR ---------- */
function checkDoorA(){
  attempts.doorA++;
  const v = document.getElementById('doorSeason').value.trim().toLowerCase();
  if(v==='autumn'){
    answers.season = v;
    setMsg('doorMsgA','<span class="ok">Correct. The panel shows one last combination lock‚Ä¶</span>');
    hide(document.getElementById('doorA')); showStep('doorB');
    updateSession({
      currentScene:'door',
      currentStep :'doorB',
      answers,
      attempts
    });
  }else{
    setMsg('doorMsgA','<span class="bad">Look at the first letters of each line in the poem.</span>');
    updateSession({ currentScene:'door', currentStep:'doorA', attempts });
  }
}

function checkDoorB(){
  attempts.doorB++;
  const a = document.getElementById('lockLib').value.trim();
  const b = document.getElementById('lockMir').value.trim().toUpperCase();
  const c = document.getElementById('lockSeason').value.trim().toLowerCase();
  if(a==='7307' && b==='CANDLELIGHT' && c==='autumn'){
    setMsg('doorMsgB','<span class="ok">All three locks turn in unison‚Ä¶</span>');
    updateSession({
      currentScene:'end',
      currentStep :'end',
      answers,
      attempts,
      finished:true
    });
    setTimeout(()=>{ showScene('scene-end','door'); }, 900);
  }else{
    setMsg('doorMsgB','<span class="bad">The mechanism refuses. Check the library code, the mirrors word and the season again.</span>');
    updateSession({ currentScene:'door', currentStep:'doorB', attempts });
  }
}
// –°–¥–µ–ª–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –≤–∏–¥–∏–º—ã–º–∏ –¥–ª—è onclick –≤ —Ä–∞–∑–º–µ—Ç–∫–µ
window.hint        = hint;
window.checkLibA   = checkLibA;
window.checkLibB   = checkLibB;
window.checkAlcA   = checkAlcA;
window.checkAlcB   = checkAlcB;
window.checkMirA   = checkMirA;
window.checkMirB   = checkMirB;
window.checkDoorA  = checkDoorA;
window.checkDoorB  = checkDoorB;
  
/* ---------- INITIAL ---------- */
initSession();
showScene('scene-intro','intro'); // boot
</script>
</body>
</html>
